# Climatemind Backend

[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)

Using Docker you need to install it first: https://www.docker.com/products/docker-desktop

On Windows it is running in a strict secure mode. You need to add the source directory to the Docker Resources: Settings / Resources / File Sharing -> add the application root directory

**_Before doing what's below, be sure the Docker application is running and the command line working directory is changed to the climatemind-backend path._**

## Running the application with Docker Compose (for development)

Build the image container to download and install code dependencies needed for running the app. **_SPECIAL NOTE_**: _Whenever the backend repo has added new dependancies in the requirements.txt file the docker image will need to be re-built by re-running the build command below ._

    docker-compose build

Start in foreground (good for debugging flask and see the logs). You can stop it with [CTRL + C] on OSX, Windows, and Linux.

    docker-compose up

Start in background (best for when trying to visualize the ontology)

    docker-compose up -d

Stop the container when running in the background. Stops containers and removes containers, networks, volumes, and images created by docker-compose up.

    docker-compose down

**_SPECIAL NOTE_**: _Sometimes the terminal says 'Running on http://0.0.0.0:5000' and that url does not work in the browser. If this happens, try going to "http://127.0.0.1:5000" instead._

## Running the application with Docker (for deployment)

The Docker lifecycle is to build the image and run it only once. After that you can stop or start the image.

Building Docker image

    docker build -t "climatemind-backend:0.1" .

Checking the built image

    docker images climatemind-backend

Running Docker

    docker run -d --name climatemind-backend --publish 5000:5000 climatemind-backend:0.1

Stop the container

    docker stop climatemind-backend

Start the container

    docker start climatemind-backend

## Api Documentation

[Swagger Documentation](http://localhost:5000/swagger) is available at detailing the API endpoints available and how they should be used. Whilst in development this can be for at [http://localhost:5000/swagger](http://localhost:5000/swagger).

---

## Processing any new Climate Mind OWL ontology file

Follow these instructions to process a new version of a Climate Mind ontology OWL file into files used by Climate Mind (such as Networkx pickle file, test ontology JSON, edge list output CSV, etc).

1. Download the new OWL ontology file (if haven't already) and move the file to the folder in the climatemind-backend directory folder cryptically named 'PUT_NEW_OWL_FILE_IN_HERE' ;)

2. Change the directory to be the climatemind-backend by using the following command with the part in caps replaced with the path to climatemind-backend on your system (for mac):

   for OSX: `cd PATH_TO_CLIMATEMIND-BACKEND`

3. Process the OWL file either without the visualization app being triggered (OPTION A) or with visualization being triggered (OPTION B)

    * OPTION A. Do this option for processing the new OWL file _without_ visualizing it after it's done processing: From the climatemind-backend directory run process_new_ontology_file.py using the climatemind docker image running in the background. Note: New files will be generated and appear in the climatemind-backend directory. These files are also listed in the git.ignore file, so don't worry about them getting pushed accidentally to the git repo.

        for OSX, run this *exactly* as below:
    ```    
        docker-compose up -d
        CLIMATEMIND_ID=$(docker ps -lq)
        docker exec -it $CLIMATEMIND_ID python process_new_ontology_file.py
    ```

    * OPTION B. Do this option for processing the new OWL file _with_ visualizing it after it's done processing. Follow these instructions to visualize an OWL file using the Dash dashboard generated by the visualize.py script:  From the climatemind-backend directory run the process_new_ontology_and_visualize.py using the climatemind docker image running in the background. Note: New files will be generated and appear in the climatemind-backend directory. These files are also listed in the git.ignore file, so don't worry about them getting pushed accidentally to the git repo.

        for OSX, run this *exactly* as below:
    ```    
        docker-compose up -d
        CLIMATEMIND_ID=$(docker ps -lq)
        docker exec -it $CLIMATEMIND_ID python process_new_ontology_and_visualize.py
    ```

## Extra details if started the visualization script directly above.

4. After running step 3 OPTION B above, find the URL that appears in the terminal and go to it in your internet browser.

    Example: "Dash is running on http://127.0.0.1:8050/" appears in the terminal, so go to http://127.0.0.1:8050/ in your internet browser.


5. Use the visualization dashboard in your internet browser.

6. When done using the dashboard, close the browser and stop the script from running by going to the terminal and pressing [CTRL + C]

## Code Style
The python code is style using [Black](https://pypi.org/project/black/)

You can run Black locally to see which files need formatting using `python3 -m black --check ./`

You can use Black to automatically format your files using `python3 -m black ./`
